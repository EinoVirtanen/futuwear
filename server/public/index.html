<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta content='width=device-width, height=device-height, initial-scale=1' name='viewport' />
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.6/Chart.bundle.js"></script>

	<link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
	<title>Futuwear</title>
	<style>
		.app {
			max-width:500px;
			padding:2em;
			margin: 0 auto;
		}
		#stage {
			min-height:2em;
		}
		iframe {
			width: 100%;
			height: 100%;
		}
		#torso_wrapper {
			overflow: auto;
			resize:vertical;
			width:100%;
			height:10em;
			min-height:80px;
		}
		td {
			padding: 0.5em;
		}
	</style>
</head>
<body>
	<div class="app">
		<h3>The Futuwear Portal</h3>
		<br><br><br>
		
		
		<b>Real-time data (websocket)</b>
		<input id="status" value="" style="width:100%;" readonly>
		<div id="knobs"></div>
		<div id="torso_wrapper">
			<iframe style="border:0px;" id="torso">Your browser doesn't support iframes, so we can't visualise real-time posture data.</iframe>
		</div>
		<br><br><hr><br>
		
		
		
		
		<b>Archived data (SQL)</b><br>
		<input type="number" id="time0"> -> <input type="number" id="timeT"> <button onclick="history(parseInt(document.getElementById('time0').value), parseInt(document.getElementById('timeT').value))">Fetch</button>
		
		<br><a href="#" onclick="document.getElementById('epochconverter').style.display='block';document.getElementById('epochconverter').src='http://www.epochconverter.com/';this.style.display='none'"><small>EPOCH times lookup</small></a>
		
		<iframe src="" id="epochconverter" style="display:none;"></iframe>
		<br><br>
		<canvas id="plot" width="400" height="400"></canvas><br><a href="#" onclick="document.getElementById('list').style.display='block';this.style.display='none'"><small>Show tabular data</small></a>
		
		<table id="list" style="display:none;"><tr><td>No data fetched yet</td></tr></table>
		
	</div>
	
	
	<script>
	
		document.getElementById('torso').src='torso/index.html'
	
		document.getElementById("time0").value = Math.floor(Date.now()/1000) - 10*60 // Ten minutes ago
		document.getElementById("timeT").value = Math.floor(Date.now()/1000) + 10*60 // Ten minutes from now
		document.getElementById("status").value = "No live data available"
		
		function history(time0, timeT) {
			console.log("Getting history from " + time0 + " to " + timeT)
			$.get("/fetch", "data=" + JSON.stringify({time0: time0, timeT: timeT}), function (resp) {
				try {
					$("#list").html("<tr><td colspan='3'>Records from <b>"+(new Date(time0*1000).toLocaleString())+"</b> to <b>"+(new Date(timeT*1000).toLocaleString())+"</b></td></tr>")
					var dataPoints = {data: [], labels: []}
					for (var i = 0; i < resp.length; i++) {
						var reading = resp[i]
						
						var sensorID = reading["sensorID"]
						var logged = new Date(reading["logged"] * 1000)
						var val = parseInt(reading["val"])
						
						$("#list").append("<tr><td><b>" + sensorID + "</b></td><td>" + val + "</td><td><small>" + timeSince(logged) + " ago</small></td></tr>")
						dataPoints.data.push(val)
						dataPoints.labels.push(logged.toLocaleTimeString().replace('.',':').replace('.',':'))
					}
					console.log(JSON.stringify(dataPoints))
					
					var graphData = {
						labels: dataPoints.labels,
						datasets: [
							{
								label: "Sensor Reading",
								data: dataPoints.data,
							}
						]
					};
					Chart.Line(plot, {
						data: graphData
					});
					
					if (i >= 100) {
						$("#list").append("<tr><td colspan='3'>Some data may have been truncated</td></tr>")
					}
					else if (i <= 0) {
						$("#list").append("<tr><td colspan='3'>No records were found</td></tr>")
					}
				} catch (e) {
					console.log("JSON data problem: " + e.message)
				}
			})
		}
		
		function postToFrame(callbackID, sensorValue) {
			var context = document.getElementById("torso").contentWindow.animator
			if (!!callbackID && typeof sensorValue != "undefined") {
				context.sensor_update_degree("R_Shoulder_Y_Rot", 0, 1000, sensorValue)
				context.sensor_update_degree("L_Shoulder_Y_Rot", 0, 1000, sensorValue)
				context.rotate_all()
			}
			else
				return context.callbacks
				
		}
		
		var bounds = {min: 0, max: 1000} //TODO: Make this dynamic
		
		var socket = io.connect("http://futuwear.tunk.org:13337");
		
		var views = {} // List of callback functions
		
		socket.on('message', function(resp){
			var now = Math.floor(new Date() / 1000)
			try {
				var sensors = json(resp)["sensors"]
				
				if (sensors == undefined)
					throw new Error("Key 'sensors' is absent.")
				else if (!sensors[0])
					sensors = [sensors] // Deal with single-sensor JSON data
				
				console.log("Received readings from " + sensors.length + " sensors.")
			
				// Iterate through all the received sensors
				for (var i = 0; i < sensors.length; i++) {
					var sensor = sensors[i]
					var value = parseInt(sensor.collection[0].value)
					if (typeof views[sensor.name] != "function") {
						
						$("#knobs").append("<progress id='" + sensor.name + "' max='" + (bounds.max - bounds.min) + "' value='0'></progress> <span id='label" + sensor.name + "'></span><br>\n")
						
						var domify = function (newVal) {
							$("#" + sensor.name).val(newVal)
							$("#label" + sensor.name).html(newVal)
						}
						
						// FIXME: Dont force iframe update
						if (false && typeof postToFrame()[sensor.name] == "undefined") {
							views[sensor.name] = domify
						}
						else {
							views[sensor.name] = function(newVal) {
								postToFrame("get_rotation", newVal) // FIXME
								domify(newVal)
							}
						}
					}
					
					var callback = views[sensor.name]
					callback(value - bounds.min)
				}
				
				$("#status").val("Got data")
			} catch (e) {
				$("#status").val("JSON data problem: " + e.message)
			}
		});
		
		$(window).on('beforeunload', function(){
			socket.close();
		});
		
		var plot = document.getElementById("plot");
		
		
		// FROM http://stackoverflow.com/questions/3177836/how-to-format-time-since-xxx-e-g-4-minutes-ago-similar-to-stack-exchange-site
		function timeSince(date) {

			var seconds = Math.floor((new Date() - date) / 1000);

			var interval = Math.floor(seconds / 31536000);

			if (interval > 1) {
				return interval + " years";
			}
			interval = Math.floor(seconds / 2592000);
			if (interval > 1) {
				return interval + " months";
			}
			interval = Math.floor(seconds / 86400);
			if (interval > 1) {
				return interval + " days";
			}
			interval = Math.floor(seconds / 3600);
			if (interval > 1) {
				return interval + " hours";
			}
			interval = Math.floor(seconds / 60);
			if (interval > 1) {
				return interval + " minutes";
			}
			return Math.floor(seconds) + " seconds";
		}
		
		/* A function to validate any object into a JSON object, defaulting to {}*/
		function json(data) {
			try {
				if (typeof data == "string")
					return JSON.parse(data)
				else if (typeof JSON.parse(JSON.stringify(data)) == "object")
					return data
				else throw new Error("")
			} catch (e) {
				console.log("JSON data is faulty, calling it {}")
				return {}
			}
		}


	</script>
</body>
</html>