<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta content='width=device-width, height=device-height, initial-scale=1' name='viewport' />
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
	<title>Futuwear</title>
	<style>
		.app {
			max-width:500px;
			padding:2em;
			margin: 0 auto;
		}
		#stage {
			min-height:2em;
		}
		.frame { 
			 background-color: transparent;
			 background-image: url(sprite-posture28ef0e6bf505c22e983297120bedf6d4.jpg);
			 background-repeat: no-repeat;
			 width: 680px;  
			 height: 700px;
			 margin-left:-100px;
		}
		.frame-0 { background-position: 0 0; }
		.frame-1 { background-position: -1360px 0; } 
		.frame-2 { background-position: -2040px 0; } 
		.frame-3 { background-position: -2720px 0; } 
		.frame-4 { background-position: -3400px 0; } 
		.frame-5 { background-position: -4080px 0; } 
		.frame-6 { background-position: -4760px 0; } 
		.frame-7 { background-position: -5440px 0; } 
	</style>
</head>
<body>
	<div class="app">
		<h3>The Futuwear Portal</h3>
		<br><br><br>
		<input id="status" value="(loading)" style="width:100%;" readonly>
		<br><br><br>
		<div id="knobs"></div>
		<div id="figure" class="frame frame-0" onclick="this.style.display='none';"></div>

		<button onclick="fetch()" style="display:none;">Refresh</button>
	</div>
	
	<script>

		var sensorBounds = [0, 100] //TODO: Make this dynamic

		function fetch() {
			$.get("/fetch", "", function (resp) {
				try {
					var sensors = resp["sensors"]
					var devices = sensors.length
					var sensorPackage
					
					// Deal with single-sensor JSON data
					if (devices == null) {
						devices = 1
						sensorPackage = sensors
					}
					else sensorPackage = sensors[0]
				
					for (var i = 0; i < devices; i++) {
						var sensorName = sensorPackage["name"]
						var dataPoints = sensorPackage["collection"]
						
						var average = Math.round(dataPoints.reduce(function (prev, curr, i, arr) {
							return prev + curr["value"] / (devices + 1)
						}, 0))

						if ($("#" + sensorName).length <= 0)
							$("#knobs").append("<input type='range' id='" + sensorName + "' min='" + sensorBounds[0] + "' max='" + sensorBounds[1] + "' value='0'>\n")
						else if ($("#" + sensorName).val() == average) {
							$("#status").val("Received data is stagnant. Run simulate-sensor.js")
						}
						else {
							$("#status").val("Received fresh data from server (avg " + average + ")")
						}

						$("#" + sensorName).val(average)

						var picRange = 6 // Last frame of the css sprite
						var picFrame = Math.min(Math.round(average/(sensorBounds[1] + 1) * picRange), picRange)
						$("#figure").attr("class", "frame frame-" + picFrame)
						
						var sensorPackage = sensors[i + 1]

					}
				} catch (e) {
					$("#status").val("JSON data problem: " + e.message)
				}
			})
		}
		
		$(document).ready(function () {
			setInterval(function () { fetch() }, 200)
		})
	</script>
</body>
</html>