<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta content='width=device-width, height=device-height, initial-scale=1' name='viewport' />
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/futuwear-front.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.6/Chart.bundle.js"></script>

	<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	
	<title>Futuwear</title>
	<style>
		.app {
			max-width:800px;
			padding:2em;
			margin: 0 auto;
		}
		
		td {
			padding: 0.5em;
		}
		#new-sensor {
			display:none;
		}
	</style>
</head>
<body>
	<div class="app">
		<div class="alert alert-danger" style="display:none;" id="warn">This is a local instance - features requiring the server will not work</div>
		
		<div class="row">
			<div class="col-xs-9">
				<h3>The Futuwear Portal</h3>
			</div>
			<div class="col-xs-3" style="text-align:right;">
				<h3><a href="javascript:history.back(0)" data-toggle="tooltip" title="Back" data-placement="bottom"><i class="fa fa-arrow-left" aria-hidden="true"></i></a></h3>
			</div>
		</div>
		<div class="" id="devices"></div>
		<br><br>
		<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#login-modal">
			<i class="fa fa-tachometer" aria-hidden="true"></i> Add Device
		</button>
		<br><hr></br>
		
		<div id="device-list">
			<h4>Your Devices</h4>
			<table id="list"><tr><td>loading</td></tr></table>
			<br><br>
			<button type="button" class="btn btn-danger" onclick="logout()">
				Forget All
			</button>	
			<hr><br>
		</div>
		
		<div class="modal fade" id="login-modal">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						<h4 class="modal-title">Watch a New Device</h4>
					</div>
					<div class="modal-body">
						<p>
							<input type="text" class="form-control" id="newDevice" placeholder="Unique Device Name" value="">
						</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary" onclick="login(document.getElementById('newDevice').value)" id="newDeviceAdd" data-dismiss="modal">Add!</button>
					</div>
				</div>
			</div>
		</div>
		
	</div>
	
	
	
	<script>
	
		$("#newDevice").keyup(function(event){
			if(event.keyCode == 13){
				$("#newDeviceAdd").click();
			}
		});
	
		if (window.location.host.indexOf("tunk") < 0)
			$("#warn").show()
			
		function fetch() {
			
			$.get("/sensors", "", function (res) {
			
				$("#list").html("<tr><td>Sensor</td><td></td><td>Smart device</td></tr>")
				
				try {
					var resp = json(res)
					
					if (typeof resp["error"] != "undefined")
						throw new Error(resp["error"])
					
					console.log(JSON.stringify(resp))
					
					// Iterate through all sensors
					for (var i = 0; i < resp.length; i++) {
						var reading = resp[i]
						
						var sensorID = reading["ID"]
						var sensorName = reading["name"]
						var deviceKey = reading["ownerKey"]
						
						if (!$("#option-" + deviceKey).length) {
							$("#device").append("<option value='"+deviceKey+"' id='option-"+deviceKey+"'>"+deviceKey+"</option>")
						}
						$("#new-sensor").show()
						
						$("#list").append("<tr><td><b>" + sensorName + "</b> <span class='badge' data-toggle='tooltip' title='We have received this many readings' data-placement='right'>"+reading.collection+"</span></td><td></td><td><small>" + deviceKey + " </small></td></tr>")
					}
					
					$('[data-toggle="tooltip"]').tooltip();
					
					if (i >= 100) {
						$("#list").append("<tr><td colspan='3'>Some data may have been truncated</td></tr>")
					}
					else if (i <= 0) {
						throw new Error("No sensors could be found");
					}
				} catch (e) {
					console.log("Problem loading sensors: " + e.message)
					$("#list").append("<tr><td colspan='3'>" + e.message + "</td></tr>")
				}
			})
		}
		var devices = devices()
	
		$(document).ready(function () {
			fetch();
			setInterval(function () { fetch(); }, 5000)
			var deviceMsg = ""			
			switch (devices.length) {
				case 0:
					$("#device-list").hide()
					break;
				case 1:
					deviceMsg += "You are tuned into your smart device " + devices.join(", ")
					break;
				default:
					deviceMsg += "You are watching devices " + devices.join(", ")
					break;
			}
			
			$('[data-toggle="tooltip"]').tooltip();
			
			$("#devices").html(deviceMsg)
		})
		
		
		function login(uname) {
			if (devices.indexOf(uname) >= 0 || !uname)
				return
			if (readCookie("devices"))
				uname = uname + "," + readCookie("devices")
			createCookie("devices", uname, 1)
			setTimeout(function () { location.reload(); }, 100) 
		}
		
		function logout() {
			removeCookie("devices")
			location.reload(); 
		}
		console.log("Watched device(s): " + devices.join(" "))
	</script>
</body>
</html>