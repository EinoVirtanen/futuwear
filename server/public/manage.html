<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta content='width=device-width, height=device-height, initial-scale=1' name='viewport' />
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/futuwear-front.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.6/Chart.bundle.js"></script>

	<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	
	<title>Futuwear</title>
	<style>
		.app {
			max-width:800px;
			padding:2em;
			margin: 0 auto;
		}
		
		td {
			padding: 0.5em;
		}
		#new-sensor {
			display:none;
		}
	</style>
</head>
<body>
	<div class="app">
		<div class="alert alert-danger" style="display:none;" id="warn">This is a local instance - features requiring the server will not work</div>
		
		<div class="row">
			<div class="col-xs-9">
				<h3>The Futuwear Portal</h3>
			</div>
			<div class="col-xs-3" style="text-align:right;">
				<h3><a href="javascript:history.back(0)" data-toggle="tooltip" title="Back" data-placement="bottom"><i class="fa fa-arrow-left" aria-hidden="true"></i></a></h3>
			</div>
		</div>
		<br>
	
		<button onclick="login()" class="btn btn-primary">Add your device</button>
		<br><br><br>
		
		<h4>Your sensors</h4>
		<table id="list"><tr><td>loading...</td></tr></table>
		<form action="/manage.html" method="post" id="new-sensor">
			<input name="name" placeholder="New Sensor Name">
			<select name="device" id="device">
			<option disabled>Select device</option>
			</select> 
			<input type="submit" class="btn btn-primary" value="Add Sensor">
		</form>
		<br><br><hr><br>
		
		
		
		
		
	</div>
	
	
	<script>
	
		if (window.location.host.indexOf("tunk") < 0)
			$("#warn").show()
			
		function fetch() {
			$.get("/sensors", "", function (res) {
			
				$("#list").html("  ")
				
				try {
					var resp = json(res)
					
					if (typeof resp["error"] != "undefined")
						throw new Error(resp["error"])
					
					console.log(JSON.stringify(resp))
					
					// Iterate through all sensors
					for (var i = 0; i < resp.length; i++) {
						var reading = resp[i]
						
						var sensorID = reading["ID"]
						var deviceKey = reading["ownerKey"]
						
						if (!$("#option-" + deviceKey).length) {
							$("#device").append("<option value='"+deviceKey+"' id='option-"+deviceKey+"'>"+deviceKey+"</option>")
						}
						$("#new-sensor").show()
						
						$("#list").append("<tr><td><b>" + sensorID + "</b></td><td>"+reading.collection+" values</td><td><small>" + deviceKey + " </small></td></tr>")
					}
					
					if (i >= 100) {
						$("#list").append("<tr><td colspan='3'>Some data may have been truncated</td></tr>")
					}
					else if (i <= 0) {
						throw new Error("No sensors could be found");
					}
				} catch (e) {
					console.log("Problem loading sensors: " + e.message)
					$("#list").append("<tr><td colspan='3'>" + e.message + "</td></tr>")
				}
			})
		}
		var devices = devices()
	
		$(document).ready(function () {
			fetch();
			setInterval(function () { fetch(); }, 1000)
		})
		
		
		function login() {
			var uname = prompt("Device name?","proto")
			if (devices.indexOf(uname) >= 0)
				return
			if (readCookie("devices"))
				uname = uname + "," + readCookie("devices")
			createCookie("devices", uname, 1)
			location.reload(); 
		}
		
		function logout() {
			removeCookie("devices")
			location.reload(); 
		}
		console.log("Watched device(s): " + devices.join(" "))
	</script>
</body>
</html>