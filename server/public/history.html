<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta content='width=device-width, height=device-height, initial-scale=1' name='viewport' />
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.6/Chart.bundle.js"></script>

	<script type="text/javascript" src="js/futuwear-front.js"></script>
	<script type="text/javascript" src="js/jquery.knob.js"></script>
	<script type="text/javascript" src="js/bootstrap.js"></script>
	
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
	
	<title>Futuwear</title>
	<style>
		.app {
			max-width:800px;
			padding:2em;
			margin: 0 auto;
		}
		#stage {
			min-height:2em;
		}
		iframe {
			width: 100%;
			height: 100%;
		}
		#torso_wrapper {
			overflow: auto;
			resize:vertical;
			width:100%;
			height:50vh;
			min-height:80px;
			display:none;
		}
		td {
			padding: 0.5em;
		}
		#existence {
			width: 100%;
			height: 2em;
			margin: 0;
		}
		#existence div {
			height: 100%;
			padding:0px;
		}
		#existence div input {
			font-size: 10px;
			width:100%;
			height:100%;
			text-align:center;
		}
	</style>
</head>
<body>
	
	<div class="app">
		<div class="alert alert-danger" style="display:none;" id="warn">This is a local instance - features requiring <a href="http://futuwear.tunk.org/">the server</a> will not work</div>
		<div class="row">
			<div class="col-xs-9">
				<h3>The Futuwear Portal</h3>
			</div>
			<div class="col-xs-3" style="text-align:right;">
				<h3><a href="manage.html" data-toggle="tooltip" title="Configure your devices" data-placement="bottom"><i class="fa fa-tachometer" aria-hidden="true"></i></a></h3>
			</div>
		</div>
		
		
		<br><br>
		
		<b>Your posture (12 hours from the last activity)</b><br><br>
		<div id="torso_wrapper">
			<iframe style="border:0px;" id="torso">Your browser doesn't support iframes, so we can't visualise posture data.</iframe>
		</div>
		<input type="range" min="-43199" max="0" id="time" onchange="timeMachine(this)" oninput="timeMachine(this)"><br>
		<div id="existence" class="row"></div>
		<button class="btn" onclick="animate(document.getElementById('time'), document.getElementById('time').value)">Animate</button>
		<span id="clock">(move slider first)</span>
		<div id="knobs" class="row"></div>
		<br><br><hr><br>
		<a href="https://github.com/EinoVirtanen/futuwear">Git</a> | <a href="https://github.com/futurice/vor">VÃ¶r</a>
		
	</div>
	
	
	<script>
		var torso = document.getElementById("torso")
		
		var animationInterval = 50
		if (window.location.host.indexOf("tunk") < 0)
			$("#warn").show()
		
		var torso = document.getElementById("torso")
		
		var archive = {}
		var maxTime = Math.floor(new Date() / 1000)
		
		function timeMachine(selector) {
		
			var val = parseInt(selector.value)
			
			var sqlTime = (maxTime + val)
			var jsTime = new Date(sqlTime * 1000)
			
			var h = jsTime.getHours()
			var m = jsTime.getMinutes()
			var s = jsTime.getSeconds()
			var currentTime = new Date()
			
			$("#clock").html(timeString(h, m, s))
			
			try {				
				var tuple = archive[sqlTime]
				
				for (var i = 0; i < tuple.length; i++) {
					var collection = tuple[i]
					
					appendVisualiser(views, collection.sensorID, collection.sensorName, "knobs")
										
					var callback = views[collection.sensorID]
					callback(collection.val - bounds.min)
				}
				return true
			} catch (e) {
				console.log("Error " + JSON.stringify(e))
				return true
			}
		}
		
		
		function animate(selector, prevIndex) {
			if (parseInt(selector.value) == parseInt(prevIndex) && timeMachine(selector)) {
				console.log("animating")
				selector.value = parseInt(prevIndex) + 1
				setTimeout(function () {animate(selector, parseInt(prevIndex) + 1)}, animationInterval)
			}
			else console.log("NOT animating")
		}
		
		
		function history(time0, timeT) {
			console.log("Getting history from " + time0 + " to " + timeT)
			
			$("#existence").html("")
			
			$.get("/fetch", "data=" + JSON.stringify({time0: time0, timeT: timeT}), function (resp) {
				try {
					
					maxTime = resp.reduce(function(highest, tuple){
						return highest > tuple.logged ? highest : tuple.logged
					}, 0)
					var maxTime2 = 0
					
					hourPoints = {}
					
					console.log(JSON.stringify(resp))
					
					archive = {}
						
					for (var i = 0; i < resp.length; i++) {
					
						var reading = resp[i]
						var logTimestamp = new Date(reading["logged"] * 1000)
						
						
						var hoursAgo = Math.floor((maxTime - reading.logged) / 3600)
						hourPoints[hoursAgo] = (hourPoints[hoursAgo] || 0) + 1
						
						maxTime2 = Math.max(maxTime2, reading.logged)
						
						var payload = {val: reading.val, sensorID: reading.sensorID, sensorName: reading.sensorName}
						if (typeof archive[parseInt(reading.logged)] == "undefined")
							archive[parseInt(reading.logged)] = [payload]
						else archive[parseInt(reading.logged)].push(payload)
						
					}
					
					console.log("Max times match? " + maxTime + " / " + maxTime2)
					
					for (var i = 0; i < 12; i++) {

						$("#existence").append("<div class='col-xs-1'><input type='text' id='hour"+(11 - i)+"' value='"+hourPoints[i]+"' size='5' readonly></div>")
					}
					
				} catch (e) {
					console.log("JSON data problem: " + e.message)
				}
			})
		}
		
		var views = {} // List of callback functions
		
		$(document).ready(function(){
			$('[data-toggle="tooltip"]').tooltip();	
			var time0 = Math.floor(Date.now()/1000) - 10*60 // Ten minutes ago
			var timeT = Math.floor(Date.now()/1000) + 10*60 // Ten minutes from now	
			history(time0, timeT)
		});
		


	</script>
	
	<br><br><br>
	
</body>
</html>